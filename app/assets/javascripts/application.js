// Generated by CoffeeScript 1.9.3
(function() {
  var $, _, calendar, env, fullcalendar, h, ical, login, popupCenter, renderUser,
    slice = [].slice;

  _ = require('underscore');

  $ = require('jquery');

  fullcalendar = require('fullcalendar');

  h = require('helpers');

  ical = require('ical');

  env = window.env = {};

  popupCenter = function(url, width, height, name) {
    var left, top;
    left = (screen.width / 2) - (width / 2);
    top = (screen.height / 2) - (height / 2);
    return window.open(url, name, "menubar=no,toolbar=no,status=no,width=" + width + ",height=" + height + ",toolbar=no,left=" + left + ",top=" + top);
  };

  login = function(callback) {
    login = $('.loader');
    if (window.user) {
      renderUser();
      $('.login').addClass("loggedin");
      $('.login').show();
      return callback();
    } else {
      $('.login').addClass("animSlow");
      $('.login').show();
      login.one('click', function(e) {
        popupCenter("/auth/facebook", 700, 700, "facebook login");
        login.css({
          opacity: 0
        });
        h.wait(500, function() {
          login.html("<i class='fa fa-spinner fa-pulse' />");
          return login.css({
            opacity: 1
          });
        });
        e.stopPropagation();
        return false;
      });
      return window.loggedin = function(user) {
        window.user = user;
        console.log("GOT USER", user);
        login.css({
          opacity: 0
        });
        return h.wait(500, function() {
          renderUser();
          login.css({
            opacity: 1
          });
          return h.wait(1000, function() {
            $('.login').addClass('loggedin');
            return h.wait(1000, callback);
          });
        });
      };
    }
  };

  renderUser = function() {
    $('.loader').html("<img class='avatar' src='" + user.image + "' /><div class='text'>" + user.name + "</div>");
    return $('.loader').click(function() {
      return document.location = '/logout';
    });
  };

  calendar = function() {
    var _colors, color;
    $('.main').fadeIn();
    calendar = env.calendar = function() {
      var args, el;
      args = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      el = $('.calendar');
      return el.fullCalendar.apply(el, args);
    };
    calendar({});
    _colors = ["#B35982", "#9BC362", "#4F9D66", "#D4796A"];
    color = window.color = function() {
      var ret;
      ret = _colors.shift();
      _colors.push(ret);
      return ret;
    };
    return $('#files').change(function(evt) {
      var files;
      files = evt.target.files;
      return _.each(files, function(file) {
        var reader;
        if (file.type !== "text/calendar") {
          return console.error("wrong file type: " + file.type);
        }
        reader = new FileReader;
        reader.onload = function(e) {
          var events, ics;
          ics = ical.parseICS(e.target.result);
          events = _.map(_.values(_.omit(ics, 'prodid')), function(data) {
            return {
              title: data.summary,
              allDay: true,
              start: data.start,
              end: data.end
            };
          });
          return calendar('addEventSource', {
            events: events,
            color: color()
          });
        };
        return reader.readAsText(file);
      });
    });
  };

  $(document).ready(function() {
    return login(function() {
      return calendar();
    });
  });

}).call(this);
